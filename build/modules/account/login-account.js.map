{"version":3,"sources":["modules/account/login-account.js"],"names":[],"mappings":"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","file":"modules/account/login-account.js","sourcesContent":["import deepmerge from 'deepmerge'\nimport field from '../check-field'\nimport {reportError} from '../log/error'\nimport { MongoClient, ObjectID } from 'mongodb'\nimport { mongodbConf, fieldsOptions } from '../../config'\nimport { createToken } from '../token-generator'\nimport bcrypt from 'bcryptjs'\n\nexport async function loginAccount(input, options) {\n  // Check input fields\n  if (!input || typeof input !== 'object' ) {\n    return reportError(\n      'Login input type not valid',\n      'Input fields is not an object type.',\n      'LOGIN_TYPE_ERROR',\n      '0d8969d0-102d-4ece-a742-4aad7cead869',\n    )\n  }\n\n  let error = {};\n\n  let fields = {\n    email: input.email || '',\n    password: input.password || '',\n    hash: input.hash || '',\n  }\n\n  let newfieldsOptions\n\n  if (options && typeof options === 'object' ) {\n    newfieldsOptions = deepmerge( fieldsOptions, options )\n  } else {\n    newfieldsOptions = {...fieldsOptions}\n  }\n\n  // Remove options don't used by loginAccount\n  for (let option in newfieldsOptions) {\n    switch (option) {\n      case 'email':\n      case 'password':\n      case 'hash':\n        continue\n      default:\n        delete newfieldsOptions[option]\n    }\n  }\n  // console.log('LLL> ' + Object.keys(newfieldsOptions))\n\n  // Check fields with its options\n  error = field.checkAll(fields, newfieldsOptions)\n\n  if (error !== null) {\n    return error\n  }\n\n  // Check login\n  let db = null,\n      colUser = null,\n      res  = null,\n      token = null,\n      passport = null,\n      user = null;\n\n  try {\n    db = await MongoClient.connect(mongodbConf.url)\n    // Check the user/email is not taken\n    colUser = db.collection('User')\n    user = await colUser.findOne({ email: fields.email })\n    // If account not found\n    if (user === null) {\n      db.close()\n      return reportError(\n        'Account Email not found.',\n        'Account Email not found.',\n        'LOGIN_ACCOUNT_NOT_FOUND_ERROR',\n        'bf4fe14b-a186-4ab6-98d9-a5435e321854',\n      )\n    }\n\n    passport = await db.collection('Passport').findOne({ user: user._id })\n    res = bcrypt.compareSync(fields.password, passport.password)\n    // If res = false then password not valid\n    if (res === false) {\n      db.close()\n      return reportError(\n        'Password not valid.',\n        'The input password is not the same as the account\\'s password',\n        'LOGIN_ACCOUNT_PASSWORD_ERROR',\n        '5b8b302d-9da7-49ae-8a92-12f34fd658b3',\n      )\n    }\n\n    db.close();\n    return {\n      email: user.email,\n      firstName: user.firstName,\n      surename: user.surename,\n      token: user.token,\n    }\n\n  } catch (error) {\n    if (db) {\n      db.close()\n    }\n\n    if ('constructor' in error && error.constructor.name == 'TypeError') {\n      console.log(error)\n      return\n    }\n\n    if (db === null || error.constains('connect ECONNREFUSED') ) {\n      return reportError(\n        'Database connection error.',\n        'It was an error in the connection with the database.',\n        'DATA_BASE_CONNECTION_ERROR',\n        'a7c5bbb7-ee5c-45fe-af13-29e3c2cda683',\n      )\n    }\n  }\n}\n"],"sourceRoot":"/source/"}