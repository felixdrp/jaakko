{"version":3,"sources":["websocket-message/server-query.js"],"names":[],"mappings":";;;;;;;;;;;;;;AAEA;;;;AAEA;;AASA;;AAMA;;AAWA;;;;AAKA;;;;;;;;;;AAjBA;;;wEA2Be;AAAA,QAAuB,MAAvB,SAAuB,MAAvB;AAAA,QAA+B,OAA/B,SAA+B,OAA/B;AAAA,QAAwC,EAAxC,SAAwC,EAAxC;AAAA,QAA4C,KAA5C,SAA4C,KAA5C;AAAA;AAAA;AAAA;AAAA;AAAA;AACT,2BADS,WAET,MAFS,WAGT,OAHS;AAAA,0BAKL,MALK;AAAA,kGAcN,aAdM;AAAA;;AAAA;AAOT;AACA,8BAAkB,yCAA4B,MAAM,QAAN,EAA5B,CAAlB;;AAEA,eAAG,IAAH,CACE,wCAAoB,eAApB,CADF;AAVS,6CAaF,IAbE;;AAAA;AAAA;AAAA,mBAgBM,aAAa;AAC1B,qBAAO,QAAQ,KADW;AAE1B,wBAAU,QAAQ;AAFQ,aAAb,CAhBN;;AAAA;AAgBT,kBAhBS;;AAoBT,oBAAQ,GAAR,CAAY,MAAZ;;AApBS,kBAsBL,aAAa,MAtBR;AAAA;AAAA;AAAA;;AAuBP;AACA;AACA,oBAAQ,KAAR,CAAc,OAAO,OAArB;AACA,gBACE,OAAO,OAAP,KAAmB,iCAAnB,IACA,OAAO,OAAP,KAAmB,4CAFrB,EAGE;AACA,gCAAkB,EAAE,OAAO,wBAAT,EAAlB;AACD,aALD,MAKO,IACL,OAAO,OAAP,KAAmB,qBADd,EAEL;AACA,gCAAkB,EAAE,UAAU,2BAAZ,EAAlB;AACD,aAJM,MAIA,IACL,OAAO,OAAP,KAAmB,0BADd,EAEL;AACA,gCAAkB,EAAE,OAAO,mCAAT,EAAlB;AACD;AACD;AACA,eAAG,IAAH,CACE;AACE,yCADF;AAEE,sBAAQ,mBAFV;AAGE,uBAAS;AAHX,aADF;AAzCO;;AAAA;AAkDT;AACA;AACA,eAAG,WAAH,GAAiB,QAAQ,KAAzB;;AAEA,sBAAU;AACR,qBAAO,QAAQ,KADP;AAER,yBAAW,OAAO,SAFV;AAGR,wBAAU,OAAO,QAHT;AAIR,qBAAO,OAAO,KAJN;AAKR,kBAAI;AALI,aAAV;;AAQA,oBAAQ,GAAR,CAAY,YAAZ;AACA,gEAAoD,OAApD;AACA,oBAAQ,GAAR,CAAY,YAAZ;AACA,oBAAQ,GAAR,CAAY,MAAM,QAAN,EAAZ;AACA;AACA;AAnES,6CAoEF,IApEE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;WAAe,K;;;;SAAA,K;;;AAhB9B;AA7BA;AACA","file":"websocket-message/server-query.js","sourcesContent":["// WebSocket communications types\n// look doc/server-websocket-message-system.md\nimport Immutable from 'immutable'\n\nimport {\n  MUTATE,\n  QUERY,\n  ACTION,\n\n  wsGotoPage,\n  swUpdateControlRoom,\n} from './server-actions'\n\nimport {\n  SESSION_STATE_GET,\n} from './query-actions'\n\n\n// Redux server actions\nimport {\n  // Remove the WS from a store state\n  storeStateWithoutWebSocket,\n  groupsAdd,\n  groupsRemove,\n  groupsAddAccount,\n  groupsRemoveAccount,\n  moveAccounFromGroup,\n} from '../actions/actions'\n\n// Redux client actions\nimport {\n  // ACCOUNT_REGISTER_ERROR,\n  // ACCOUNT_LOGIN_ERROR,\n} from '../actions/client-actions'\n\n/**\n * Query will process an asynchronous message from a client send by a websocket\n *\n * @param {Object} An object whose values correspond to:\n *                    action: Async action to process\n *                    payload: The info to process\n *                    ws: websocket that trigger the message.\n * @returns {}\n */\n\nexport default async function query({ action, payload, ws, store }) {\n  let payloadResponse,\n      result,\n      account\n\n  switch (action) {\n    case SESSION_STATE_GET:\n      // update state in components ControlRoom socket action creator\n      payloadResponse = storeStateWithoutWebSocket( store.getState() )\n\n      ws.send(\n        swUpdateControlRoom(payloadResponse)\n      )\n      return true\n    case LOGIN_ACCOUNT:\n      // Login an Account\n      result = await loginAccount({\n        email: payload.email,\n        password: payload.password,\n      })\n      console.log(result)\n\n      if ('message' in result) {\n        // Error try login.\n        // Send message of error to the client.\n        console.error(result.message)\n        if (\n          result.message === 'The input field email not valid' ||\n          result.message === 'The input field email is not a valid email'\n        ) {\n          payloadResponse = { email: 'The email is not valid' }\n        } else if (\n          result.message === 'Password not valid.'\n        ) {\n          payloadResponse = { password: 'The password is not valid' }\n        } else if (\n          result.message === 'Account Email not found.'\n        ) {\n          payloadResponse = { email: 'Please, check email and password.' }\n        }\n        // Send email error\n        ws.send(\n          {\n            type: ACTION,\n            action: ACCOUNT_LOGIN_ERROR,\n            payload: payloadResponse,\n          }\n        )\n        return\n      }\n      // Register the websocket 'ws.accountCode' with the email.\n      // So we can identify the ws with the account email.\n      ws.accountCode = payload.email\n\n      account = {\n        email: payload.email,\n        firstName: result.firstName,\n        surename: result.surename,\n        token: result.token,\n        ws: ws,\n      }\n\n      console.log('>>>>>state')\n      reduxStoreServerAndClientRegisterAccountAndGoToWait(account)\n      console.log('>>>>>state')\n      console.log(store.getState())\n      // console.log('send error login')\n      // console.log(ws.name +' '+ message.type + ' ' + message.payload.email)\n      return true\n      break;\n  }\n}\n"],"sourceRoot":"/source/"}