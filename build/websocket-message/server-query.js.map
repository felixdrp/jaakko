{"version":3,"sources":["websocket-message/server-query.js"],"names":["action","payload","ws","store","payloadResponse","result","account","temp","getState","send","accounts","list","includes","console","log","type","session","surveyPath","surveyPointer","groupType","groups","group","taskType","indexOf","length","ideas","task","taskList","taskPointer","filter","element","selectedGroup","similarList","favouritList","mathPointer","findIndex","mathResults","results","surveyInfo","surveyId","groupId","query"],"mappings":"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","file":"websocket-message/server-query.js","sourcesContent":["// WebSocket communications types\n// look doc/server-websocket-message-system.md\nimport Immutable from 'immutable'\n\nimport {\n  MUTATE,\n  QUERY,\n  ACTION,\n\n  wsGotoPage,\n  swUpdateControlRoom,\n  swSetSurveyInitials,\n} from './server-actions'\n\nimport {\n  SESSION_STATE_GET,\n  SURVEY_STATE_GET,\n} from './query-actions'\n\nimport {\n  AWAIT,\n  QUESTION,\n  INSTRUCTIONS,\n  MATH_CHALLENGE,\n  ALT_OBJECT_TASK,\n  SIMILARITIES,\n  FAVOURITES,\n  MATH_RESULTS,\n  RESULTS,\n} from '../components/survey/survey-types'\n\n// Redux server actions\nimport {\n  // Remove the WS from a store state\n  storeStateWithoutWebSocket,\n  // groupsAdd,\n  // groupsRemove,\n  // groupsAddAccount,\n  // groupsRemoveAccount,\n  // moveAccounFromGroup,\n} from '../actions/actions'\n\n// Redux client actions\nimport {\n  // ACCOUNT_REGISTER_ERROR,\n  // ACCOUNT_LOGIN_ERROR,\n} from '../actions/client-actions'\n\n/**\n * Query will process an asynchronous message from a client send by a websocket\n *\n * @param {Object} An object whose values correspond to:\n *                    action: Async action to process\n *                    payload: The info to process\n *                    ws: websocket that trigger the message.\n * @returns {}\n */\n\nexport default async function query({ action, payload, ws, store }) {\n  let payloadResponse,\n      result,\n      account,\n      temp = {}\n\n  switch (action) {\n    case SESSION_STATE_GET:\n      // update state in components ControlRoom socket action creator\n      payloadResponse = storeStateWithoutWebSocket( store.getState() )\n\n      ws.send(\n        swUpdateControlRoom(payloadResponse)\n      )\n      return true\n\n    case SURVEY_STATE_GET:\n      // Send initial values to the surveys if needed\n      temp = {}\n      result = store.getState()\n      account = payload\n\n      if ( !result.accounts.list.includes(account) ) {\n        console.log( SURVEY_STATE_GET + ': Account not found' )\n        return false\n      }\n      temp.account = result.accounts[account]\n      temp.type = result.session.surveyPath[\n        temp.account.surveyPointer\n      ].type\n\n      switch (temp.type) {\n        case INSTRUCTIONS:\n        case ALT_OBJECT_TASK:\n          temp.payload = result.session.surveyPath[\n            temp.account.surveyPointer\n          ].payload\n\n          ws.send(\n            swSetSurveyInitials( { groupType: result.groups[ temp.account.group ].type, taskType: temp.payload } )\n          )\n\n          return\n        case QUESTION:\n            temp.payload = result.session.surveyPath[\n              temp.account.surveyPointer\n            ].payload\n\n            ws.send(\n              swSetSurveyInitials( temp.payload )\n            )\n\n            return\n        case SIMILARITIES:\n          // debugger\n          if ( result.groups.list.indexOf(temp.account.group) + 1 >= result.groups.list.length ) {\n            temp.payload = {\n              group: result.groups.list[0],\n              groupType: result.groups[ result.groups.list[0] ].type,\n              ideas: result.task.taskList[ result.task.taskPointer ].filter(\n                element => result.groups.list[0] == element.group\n              ),\n            }\n          } else {\n            temp.selectedGroup = result.groups.list[ result.groups.list.indexOf(temp.account.group) + 1 ]\n            temp.payload = {\n              group: temp.selectedGroup,\n              groupType: result.groups[ temp.selectedGroup ].type,\n              ideas: result.task.taskList[ result.task.taskPointer ].filter(\n                element => temp.selectedGroup == element.group\n              ),\n            }\n          }\n\n          console.log('SIMILARITIES SIMILARITIES SIMILARITIES SIMILARITIES SIMILARITIES SIMILARITIES')\n          console.log(temp.payload)\n\n          ws.send(\n            swSetSurveyInitials( temp.payload )\n          )\n\n          return\n\n        case FAVOURITES:\n          if ( result.groups.list.indexOf(temp.account.group) - 1 < 0 ) {\n            temp.selectedGroup = result.groups.list[ result.groups.list.length - 1 ]\n            temp.payload = {\n              group: temp.selectedGroup,\n              groupType: result.groups[ temp.selectedGroup ].type,\n              ideas: result.task.similarList[ result.task.taskPointer ].filter(\n                element => temp.selectedGroup == element.group\n              ),\n            }\n          } else {\n            temp.selectedGroup = result.groups.list[ result.groups.list.indexOf(temp.account.group) - 1 ]\n            temp.payload = {\n              group: temp.selectedGroup,\n              groupType: result.groups[ temp.selectedGroup ].type,\n              ideas: result.task.similarList[ result.task.taskPointer ].filter(\n                element => temp.selectedGroup == element.group\n              ),\n            }\n          }\n\n          console.log('FAVOURITES FAVOURITES FAVOURITES FAVOURITES FAVOURITES FAVOURITES')\n          console.log(temp.payload)\n\n          ws.send(\n            swSetSurveyInitials( temp.payload )\n          )\n          return\n\n        case RESULTS:\n          try {\n\n            console.log('PRE PRE RESULTS RESULTS RESULTS RESULTS RESULTS RESULTS')\n            result = storeStateWithoutWebSocket( result )\n            temp.payload = {\n              group: temp.account.group,\n              groupType: result.groups[ temp.account.group ].type,\n              accounts: result.accounts,\n              ideas: result.task.favouritList[ result.task.taskPointer ].filter(\n                element => temp.account.group == element.group\n              ),\n            }\n\n            console.log('RESULTS RESULTS RESULTS RESULTS RESULTS RESULTS')\n            console.log(temp.payload)\n\n            ws.send(\n              swSetSurveyInitials( temp.payload )\n            )\n            return\n\n          } catch (e ) {\n            console.log(\"CAGADA: \"+e)\n          }\n          return\n\n        case MATH_RESULTS:\n          try {\n            console.log('PRE PRE MATH_MATH_RESULTS MATH_MATH_RESULTS MATH_MATH_RESULTS MATH_MATH_RESULTS MATH_MATH_RESULTS MATH_MATH_RESULTS')\n            result = storeStateWithoutWebSocket( result )\n            temp.mathPointer = result.session.surveyPath.findIndex(\n              element => element.type == MATH_CHALLENGE\n            )\n\n            temp.payload = {\n              group: temp.account.group,\n              groupType: result.groups[ temp.account.group ].type,\n              accounts: result.accounts,\n              mathResults: result.results.surveyInfo.filter(\n                element => (temp.mathPointer == element.surveyId) && (temp.account.group == element.groupId)\n              ),\n            }\n\n            console.log('MATH_RESULTS MATH_RESULTS MATH_RESULTS MATH_RESULTS MATH_RESULTS MATH_RESULTS')\n            console.log(temp.payload)\n\n            ws.send(\n              swSetSurveyInitials( temp.payload )\n            )\n            return\n\n          } catch (e ) {\n            console.log(\"CAGADA: \"+e)\n          }\n          return\n        default:\n\n      }\n\n      console.log('SESSION_STATE_GET return!!!')\n      return\n  }\n}\n"],"sourceRoot":"/source/"}