{"version":3,"sources":["websocket-message/server-mutate.js"],"names":["action","payload","ws","store","reduxStoreServerAndClientRegisterAccountAndGoToWait","account","tempAccount","dispatch","group","console","log","undefined","send","url","options","payloadResponse","result","firstName","surename","email","password","reEnterPassword","error","message","type","accountCode","token","getState","mutate"],"mappings":";;;;;;;;;;;;;;;;;;AAEA;;AAYA;;AAaA;;AAMA;;AAEA;;AACA;;;;AAEA;;;;;;;;;;AAZA;AA1BA;AACA;;wEA+Ce;AAAA,QAAwBA,MAAxB,SAAwBA,MAAxB;AAAA,QAAgCC,OAAhC,SAAgCA,OAAhC;AAAA,QAAyCC,EAAzC,SAAyCA,EAAzC;AAAA,QAA6CC,KAA7C,SAA6CA,KAA7C;AAAA,0CAKJC,mDALI;AAAA;AAAA;AAAA;AAAA;AAKJA,+DALI,YAKJA,mDALI,CAKgDC,OALhD,EAKyD;AACpE,kBAAIC,oBAAJ;AACA;AACAH,oBAAMI,QAAN,CAAgB,qDAAgBF,OAAhB,IAAyBG,OAAO,YAAhC,IAAhB;AACAC,sBAAQC,GAAR,CAAY,YAAZ;;AAEA;AACAJ,uDAAkBD,OAAlB,IAA2BH,IAAIS,SAA/B;AACA,qBAAOL,YAAYJ,EAAnB;AACAA,iBAAGU,IAAH,CAAU,iCAAaP,OAAb,CAAV;AACAI,sBAAQC,GAAR,CAAY,YAAZ;;AAEA;AACAR,iBAAGU,IAAH,CACE,+BAAW,EAAEC,KAAK,kBAAP,EAA2BC,SAAS,EAApC,EAAX,CADF;AAGAL,sBAAQC,GAAR,CAAY,YAAZ;AAED,aAvBY;;AACTK,2BADS,WAETC,MAFS,WAGTX,OAHS;AAAA,0BAyBLL,MAzBK;AAAA;AAAA;;AAAA;AAAA;AAAA,mBA4BM,kCACb;AACEiB,yBAAWhB,QAAQgB,SADrB;AAEEC,wBAAUjB,QAAQiB,QAFpB;AAGEC,qBAAOlB,QAAQkB,KAHjB;AAIEC,wBAAUnB,QAAQmB,QAJpB;AAKEC,+BAAiBpB,QAAQmB;AAL3B,aADa,wBA5BN;;AAAA;AA4BTJ,kBA5BS;;AAAA,kBAsCL,aAAaA,MAtCR;AAAA;AAAA;AAAA;;AAuCP;AACA;AACAP,oBAAQa,KAAR,CAAcN,OAAOO,OAArB;AACA,gBACEP,OAAOO,OAAP,KAAmB,iCAAnB,IACAP,OAAOO,OAAP,KAAmB,4CAFrB,EAGE;AACAR,gCAAkB,EAAEI,OAAO,wBAAT,EAAlB;AACD,aALD,MAKO,IACLH,OAAOO,OAAP,KAAmB,oCADd,EAEL;AACAR,gCAAkB,EAAEK,UAAU,2BAAZ,EAAlB;AACD,aAJM,MAIA,IACLJ,OAAOO,OAAP,KAAmB,qBADd,EAEL;AACAR,gCAAkB,EAAEI,OAAO,+BAAT,EAAlB;AACD;AACD;AACAjB,eAAGU,IAAH,CACE;AACEY,yCADF;AAEExB,2DAFF;AAGEC,uBAASc;AAHX,aADF;AAzDO;;AAAA;AAkET;AACA;AACA;AACA;AACA;AACAb,eAAGuB,WAAH,GAAiBxB,QAAQkB,KAAzB;;AAEAd,sBAAU;AACRc,qBAAOlB,QAAQkB,KADP;AAERF,yBAAWhB,QAAQgB,SAFX;AAGRC,wBAAUjB,QAAQiB,QAHV;AAIRQ,qBAAOV,MAJC;AAKRd;AALQ,aAAV;AAOAE,gEAAoDC,OAApD;AACA;AAjFS,6CAkFF,IAlFE;;AAAA;AAAA;AAAA,mBAuFM,gCAAa;AAC1Bc,qBAAOlB,QAAQkB,KADW;AAE1BC,wBAAUnB,QAAQmB;AAFQ,aAAb,CAvFN;;AAAA;AAuFTJ,kBAvFS;;AA2FTP,oBAAQC,GAAR,CAAYM,MAAZ;;AA3FS,kBA6FL,aAAaA,MA7FR;AAAA;AAAA;AAAA;;AA8FP;AACA;AACAP,oBAAQa,KAAR,CAAcN,OAAOO,OAArB;AACA,gBACEP,OAAOO,OAAP,KAAmB,iCAAnB,IACAP,OAAOO,OAAP,KAAmB,4CAFrB,EAGE;AACAR,gCAAkB,EAAEI,OAAO,wBAAT,EAAlB;AACD,aALD,MAKO,IACLH,OAAOO,OAAP,KAAmB,qBADd,EAEL;AACAR,gCAAkB,EAAEK,UAAU,2BAAZ,EAAlB;AACD,aAJM,MAIA,IACLJ,OAAOO,OAAP,KAAmB,0BADd,EAEL;AACAR,gCAAkB,EAAEI,OAAO,mCAAT,EAAlB;AACD;AACD;AACAjB,eAAGU,IAAH,CACE;AACEY,yCADF;AAEExB,wDAFF;AAGEC,uBAASc;AAHX,aADF;AAhHO;;AAAA;AAyHT;AACA;AACAb,eAAGuB,WAAH,GAAiBxB,QAAQkB,KAAzB;;AAEAd,sBAAU;AACRc,qBAAOlB,QAAQkB,KADP;AAERF,yBAAWD,OAAOC,SAFV;AAGRC,wBAAUF,OAAOE,QAHT;AAIRQ,qBAAOV,OAAOU,KAJN;AAKRxB,kBAAIA;AALI,aAAV;;AAQAO,oBAAQC,GAAR,CAAY,YAAZ;AACAN,gEAAoDC,OAApD;AACAI,oBAAQC,GAAR,CAAY,YAAZ;AACAD,oBAAQC,GAAR,CAAYP,MAAMwB,QAAN,EAAZ;AACA;AACA;AA1IS,6CA2IF,IA3IE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;WAAeC,M;;;;SAAAA,M;;;AAhB9B;;;AAnBA","file":"websocket-message/server-mutate.js","sourcesContent":["// WebSocket communications types\n// look doc/server-websocket-message-system.md\nimport {\n  MUTATE,\n  QUERY,\n  ACTION,\n\n  LOGIN_ACCOUNT,\n  REGISTER_ACCOUNT,\n  wsLogAccount,\n  wsGotoPage,\n} from './server-actions'\n\n// Redux server actions\nimport {\n  accountsAdd,\n  accountsUpdate,\n  accountsRemove,\n\n  groupsAdd,\n  groupsRemove,\n  groupsAddAccount,\n  groupsRemoveAccount,\n  moveAccounFromGroup,\n} from '../actions/actions'\n\n// Redux client actions\nimport {\n  ACCOUNT_REGISTER_ERROR,\n  ACCOUNT_LOGIN_ERROR,\n} from '../actions/client-actions'\n\n// Default Input fields type and options\nimport { fieldsOptions } from '../config'\n\nimport { createAccount } from '../modules/account/create-account'\nimport { loginAccount } from '../modules/account/login-account'\n\n/**\n * Mutate will process an asynchronous message from a client send by a websocket\n *\n * @param {Object} An object whose values correspond to:\n *                    action: Async action to process\n *                    payload: The info to process\n *                    ws: websocket that trigger the message.\n * @returns {}\n */\n\nexport default async function mutate({ action, payload, ws, store }) {\n  let payloadResponse,\n      result,\n      account\n\n  function reduxStoreServerAndClientRegisterAccountAndGoToWait(account) {\n    let tempAccount\n    // Register the user in the server store.\n    store.dispatch( accountsAdd({...account, group: 'unassigned'}) )\n    console.log('>>>>>state')\n\n    // Log the account in the Client\n    tempAccount = {...account, ws: undefined}\n    delete tempAccount.ws\n    ws.send(  wsLogAccount(account) )\n    console.log('>>>>>state')\n\n    // Go to WaitSync to start session\n    ws.send(\n      wsGotoPage({ url: '/survey/waitSync', options: {} })\n    )\n    console.log('>>>>>state')\n\n  }\n\n  switch (action) {\n    case REGISTER_ACCOUNT:\n      // Register an Account\n      result = await createAccount(\n        {\n          firstName: payload.firstName,\n          surename: payload.surename,\n          email: payload.email,\n          password: payload.password,\n          reEnterPassword: payload.password,\n        },\n        fieldsOptions\n      )\n      if ('message' in result) {\n        // Error try register again.\n        // Send message of error to the client.\n        console.error(result.message)\n        if (\n          result.message === 'The input field email not valid' ||\n          result.message === 'The input field email is not a valid email'\n        ) {\n          payloadResponse = { email: 'The email is not valid' }\n        } else if (\n          result.message === 'The input field password not valid'\n        ) {\n          payloadResponse = { password: 'The password is not valid' }\n        } else if (\n          result.message === 'Email already used.'\n        ) {\n          payloadResponse = { email: 'Please, choose another email.' }\n        }\n        // Send email error\n        ws.send(\n          {\n            type: ACTION,\n            action: ACCOUNT_REGISTER_ERROR,\n            payload: payloadResponse,\n          }\n        )\n        return\n      }\n      // User registered!!\n      //\n      // To give websocket.accountCode the account email\n      // Register the websocket 'ws.accountCode' with the email.\n      // So we can identify the ws with the account email.\n      ws.accountCode = payload.email\n\n      account = {\n        email: payload.email,\n        firstName: payload.firstName,\n        surename: payload.surename,\n        token: result,\n        ws,\n      }\n      reduxStoreServerAndClientRegisterAccountAndGoToWait(account)\n      // Ready to asign to a group\n      return true\n      break;\n\n    case LOGIN_ACCOUNT:\n      // Login an Account\n      result = await loginAccount({\n        email: payload.email,\n        password: payload.password,\n      })\n      console.log(result)\n\n      if ('message' in result) {\n        // Error try login.\n        // Send message of error to the client.\n        console.error(result.message)\n        if (\n          result.message === 'The input field email not valid' ||\n          result.message === 'The input field email is not a valid email'\n        ) {\n          payloadResponse = { email: 'The email is not valid' }\n        } else if (\n          result.message === 'Password not valid.'\n        ) {\n          payloadResponse = { password: 'The password is not valid' }\n        } else if (\n          result.message === 'Account Email not found.'\n        ) {\n          payloadResponse = { email: 'Please, check email and password.' }\n        }\n        // Send email error\n        ws.send(\n          {\n            type: ACTION,\n            action: ACCOUNT_LOGIN_ERROR,\n            payload: payloadResponse,\n          }\n        )\n        return\n      }\n      // Register the websocket 'ws.accountCode' with the email.\n      // So we can identify the ws with the account email.\n      ws.accountCode = payload.email\n\n      account = {\n        email: payload.email,\n        firstName: result.firstName,\n        surename: result.surename,\n        token: result.token,\n        ws: ws,\n      }\n\n      console.log('>>>>>state')\n      reduxStoreServerAndClientRegisterAccountAndGoToWait(account)\n      console.log('>>>>>state')\n      console.log(store.getState())\n      // console.log('send error login')\n      // console.log(ws.name +' '+ message.type + ' ' + message.payload.email)\n      return true\n      break;\n  }\n}\n"],"sourceRoot":"/source/"}