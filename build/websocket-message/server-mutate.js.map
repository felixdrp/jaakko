{"version":3,"sources":["websocket-message/server-mutate.js"],"names":[],"mappings":";;;;;;;;;;;;;;AAEA;;AAYA;;AAaA;;AAMA;;AAEA;;AACA;;;;AAEA;;;;;;;;;;AAZA;AA1BA;AACA;;;wEA+Ce;AAAA,QAAwB,MAAxB,SAAwB,MAAxB;AAAA,QAAgC,OAAhC,SAAgC,OAAhC;AAAA,QAAyC,EAAzC,SAAyC,EAAzC;AAAA,QAA6C,KAA7C,SAA6C,KAA7C;AAAA;AAAA;AAAA;AAAA;AAAA;AACT,2BADS,WAET,MAFS;AAAA,0BAIL,MAJK;AAAA;AAAA;;AAAA;AAAA;AAAA,mBAOM,kCACb;AACE,yBAAW,QAAQ,SADrB;AAEE,wBAAU,QAAQ,QAFpB;AAGE,qBAAO,QAAQ,KAHjB;AAIE,wBAAU,QAAQ,QAJpB;AAKE,+BAAiB,QAAQ;AAL3B,aADa,wBAPN;;AAAA;AAOT,kBAPS;;AAAA,kBAiBL,aAAa,MAjBR;AAAA;AAAA;AAAA;;AAkBP;AACA;AACA,oBAAQ,KAAR,CAAc,OAAO,OAArB;AACA,gBACE,OAAO,OAAP,KAAmB,iCAAnB,IACA,OAAO,OAAP,KAAmB,4CAFrB,EAGE;AACA,gCAAkB,EAAE,OAAO,wBAAT,EAAlB;AACD,aALD,MAKO,IACL,OAAO,OAAP,KAAmB,oCADd,EAEL;AACA,gCAAkB,EAAE,UAAU,2BAAZ,EAAlB;AACD,aAJM,MAIA,IACL,OAAO,OAAP,KAAmB,qBADd,EAEL;AACA,gCAAkB,EAAE,OAAO,+BAAT,EAAlB;AACD;AACD;AACA,eAAG,IAAH,CACE;AACE,yCADF;AAEE,2DAFF;AAGE,uBAAS;AAHX,aADF;AApCO;;AAAA;AA6CT;AACA;AACA;AACA;AACA;AACA,eAAG,WAAH,GAAiB,QAAQ,KAAzB;;AAEA;;AAEA;AACA,eAAG,IAAH,CACE,iCAAa;AACX,qBAAO,QAAQ,KADJ;AAEX,yBAAW,QAAQ,SAFR;AAGX,wBAAU,QAAQ,QAHP;AAIX,qBAAO;AAJI,aAAb,CADF;AAQA;AA/DS,6CAgEF,IAhEE;;AAAA;AAAA;AAAA,mBAqEM,gCAAa;AAC1B,qBAAO,QAAQ,KADW;AAE1B,wBAAU,QAAQ;AAFQ,aAAb,CArEN;;AAAA;AAqET,kBArES;;AAyET,oBAAQ,GAAR,CAAY,MAAZ;;AAzES,kBA2EL,aAAa,MA3ER;AAAA;AAAA;AAAA;;AA4EP;AACA;AACA,oBAAQ,KAAR,CAAc,OAAO,OAArB;AACA,gBACE,OAAO,OAAP,KAAmB,iCAAnB,IACA,OAAO,OAAP,KAAmB,4CAFrB,EAGE;AACA,gCAAkB,EAAE,OAAO,wBAAT,EAAlB;AACD,aALD,MAKO,IACL,OAAO,OAAP,KAAmB,qBADd,EAEL;AACA,gCAAkB,EAAE,UAAU,2BAAZ,EAAlB;AACD,aAJM,MAIA,IACL,OAAO,OAAP,KAAmB,0BADd,EAEL;AACA,gCAAkB,EAAE,OAAO,mCAAT,EAAlB;AACD;AACD;AACA,eAAG,IAAH,CACE;AACE,yCADF;AAEE,wDAFF;AAGE,uBAAS;AAHX,aADF;AA9FO;;AAAA;AAuGT;AACA;AACA,eAAG,WAAH,GAAiB,QAAQ,KAAzB;;AAEA;AACA,eAAG,IAAH,CACE,iCAAa;AACX,qBAAO,QAAQ,KADJ;AAEX,yBAAW,OAAO,SAFP;AAGX,wBAAU,OAAO,QAHN;AAIX,qBAAO,OAAO;AAJH,aAAb,CADF;;AASA,eAAG,IAAH,CACE,+BAAW,EAAE,KAAK,kBAAP,EAA2B,SAAS,EAApC,EAAX,CADF;;AAKA;AACA;AA3HS,6CA4HF,IA5HE;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,G;;WAAe,M;;;;SAAA,M;;;AAhB9B;;;AAnBA","file":"websocket-message/server-mutate.js","sourcesContent":["// WebSocket communications types\n// look doc/server-websocket-message-system.md\nimport {\n  MUTATE,\n  QUERY,\n  ACTION,\n\n  LOGIN_ACCOUNT,\n  REGISTER_ACCOUNT,\n  wsLogAccount,\n  wsGotoPage,\n} from './server-actions'\n\n// Redux server actions\nimport {\n  accountsAdd,\n  accountsUpdate,\n  accountsRemove,\n\n  groupsAdd,\n  groupsRemove,\n  groupsAddAccount,\n  groupsRemoveAccount,\n  moveAccounFromGroup,\n} from '../actions/actions'\n\n// Redux client actions\nimport {\n  ACCOUNT_REGISTER_ERROR,\n  ACCOUNT_LOGIN_ERROR,\n} from '../actions/client-actions'\n\n// Default Input fields type and options\nimport { fieldsOptions } from '../config'\n\nimport { createAccount } from '../modules/account/create-account'\nimport { loginAccount } from '../modules/account/login-account'\n\n/**\n * Mutate will process an asynchronous message from a client send by a websocket\n *\n * @param {Object} An object whose values correspond to:\n *                    action: Async action to process\n *                    payload: The info to process\n *                    ws: websocket that trigger the message.\n * @returns {}\n */\n\nexport default async function mutate({ action, payload, ws, store }) {\n  let payloadResponse,\n      result\n\n  switch (action) {\n    case REGISTER_ACCOUNT:\n      // Register an Account\n      result = await createAccount(\n        {\n          firstName: payload.firstName,\n          surename: payload.surename,\n          email: payload.email,\n          password: payload.password,\n          reEnterPassword: payload.password,\n        },\n        fieldsOptions\n      )\n      if ('message' in result) {\n        // Error try register again.\n        // Send message of error to the client.\n        console.error(result.message)\n        if (\n          result.message === 'The input field email not valid' ||\n          result.message === 'The input field email is not a valid email'\n        ) {\n          payloadResponse = { email: 'The email is not valid' }\n        } else if (\n          result.message === 'The input field password not valid'\n        ) {\n          payloadResponse = { password: 'The password is not valid' }\n        } else if (\n          result.message === 'Email already used.'\n        ) {\n          payloadResponse = { email: 'Please, choose another email.' }\n        }\n        // Send email error\n        ws.send(\n          {\n            type: ACTION,\n            action: ACCOUNT_REGISTER_ERROR,\n            payload: payloadResponse,\n          }\n        )\n        return\n      }\n      // User registered!!\n      //\n      // To give websocket.accountCode the account email\n      // Register the websocket 'ws.accountCode' with the email.\n      // So we can identify the ws with the account email.\n      ws.accountCode = payload.email\n\n      // Register the user in the server store.\n\n      // Log the account in the Client\n      ws.send(\n        wsLogAccount({\n          email: payload.email,\n          firstName: payload.firstName,\n          surename: payload.surename,\n          token: result,\n        })\n      )\n      // Ready to asign to a group\n      return true\n      break;\n\n    case LOGIN_ACCOUNT:\n      // Login an Account\n      result = await loginAccount({\n        email: payload.email,\n        password: payload.password,\n      })\n      console.log(result)\n\n      if ('message' in result) {\n        // Error try login.\n        // Send message of error to the client.\n        console.error(result.message)\n        if (\n          result.message === 'The input field email not valid' ||\n          result.message === 'The input field email is not a valid email'\n        ) {\n          payloadResponse = { email: 'The email is not valid' }\n        } else if (\n          result.message === 'Password not valid.'\n        ) {\n          payloadResponse = { password: 'The password is not valid' }\n        } else if (\n          result.message === 'Account Email not found.'\n        ) {\n          payloadResponse = { email: 'Please, check email and password.' }\n        }\n        // Send email error\n        ws.send(\n          {\n            type: ACTION,\n            action: ACCOUNT_LOGIN_ERROR,\n            payload: payloadResponse,\n          }\n        )\n        return\n      }\n      // Register the websocket 'ws.accountCode' with the email.\n      // So we can identify the ws with the account email.\n      ws.accountCode = payload.email\n\n      // Log the account in the Client\n      ws.send(\n        wsLogAccount({\n          email: payload.email,\n          firstName: result.firstName,\n          surename: result.surename,\n          token: result.token,\n        })\n      )\n\n      ws.send(\n        wsGotoPage({ url: '/survey/waitSync', options: {} })\n      )\n\n\n      // console.log('send error login')\n      // console.log(ws.name +' '+ message.type + ' ' + message.payload.email)\n      return true\n      break;\n  }\n}\n"],"sourceRoot":"/source/"}